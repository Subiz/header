syntax = "proto3";

package account;

import "bitbucket.org/subiz/servicespec/proto/common/auth/auth.proto";

enum ErrorCode {
	OK = 0;
	NOTFOUND = 404;
	INVALID = 400;
	UNAUTHORIZED = 401;
	INTERNAL_ERROR = 500;
}

message Account {
	string Id = 1;
	string Name = 2;
	int32 State = 3;
	int32 Plan = 4;
	string LogoUrl = 7;

	string OwnerId = 5;
	bool IsClosed = 6;
}

message IdRequest {
	string Id = 1;
}

message Empty {}

message UpdatePlanRequest {
	string Id = 1;
	int32 Plan = 2;
}

message ChannelRegistryRequest {
	string AccountId = 1;
	string ClientId = 2;
}

service AccountMgr {
	rpc Create(Account) returns (CreateResponse) {}

	rpc Close(IdRequest) returns (Empty) {}
	rpc Open(IdRequest) returns (Empty) {}

	rpc Delete(IdRequest) returns (Empty) {}
	rpc UpdateInfo(Account) returns (Empty) {}
	rpc Read(IdRequest) returns (Account) {}

	// call by the system or subiz's agent to upgrade plan of
	// account after verified
	rpc UpdatePlan(UpdatePlanRequest) returns (Empty) {}
	// call by account owner to update her plan
	rpc RequestUpdatePlan(UpdatePlanRequest) returns (Empty) {}

	rpc EnableChannel(ChannelRegistryRequest) returns (Empty) {}
	rpc DisableChannel(ChannelRegistryRequest) returns (Empty) {}
	rpc ListChannel(IdRequest) returns (ListAccountChannelResponse) {}

	rpc ListLimit(EmptyRequest) returns (LimitsResponse)  {}
}

message InviteAgentRequest {
	// id of inviter
	string InviterId = 1;

	// id of account
	string AccountId = 4;

	// provide at least one, if Agent existed, provide AgentId and ignore AgentEmail,
	// if agent doen't existed, provide agent email and ignore AgentId
	string AgentId = 2;
	string AgentEmail = 3;
}

message CancelInvitationRequest {
	string AccountId = 1;

	// provide at least one, if Agent existed, provide AgentId and ignore AgentEmail,
	// if agent doen't existed, provide agent email and ignore AgentId
	string AgentId = 2;
	string AgentEmail = 3;
}

message SearchAgentRequest {
	string Email = 1;
}

message UpdatePermissionRequest {
	string AccountId = 1;
	string AgentId = 2;
	int32 Scope = 3;
}

message RateRequest {
	string AccountId = 1;
	string AgentId = 2;
	int32 Rate = 3;
}

message AccIdRequest {
	string AccountId = 1;
	string AgentId = 2;
}

message UpdateAvailableStateRequest {
	string AccountId = 1;
	string AgentId = 2;
	AvailableState AvailableState = 3;
}

service AccAgentMgr {
	rpc InviteAgent(InviteAgentRequest) returns (Empty) {}
	// delete invitation invoke by inviter
	rpc CancelInvitation(CancelInvitationRequest) returns (Empty) {}
	// delete invitation invoke by agent
	rpc RejectInvitation(CancelInvitationRequest) returns (Empty) {}

	rpc UpdateAccProfile(AccountAgent) returns (Empty) {}
	rpc Read(AccIdRequest) returns (AccountAgent) {}
	rpc Rate(RateRequest) returns (Empty) {}
	rpc UpdateAvailableState(UpdateAvailableStateRequest) returns (Empty) {}
	rpc GrantPermission(UpdatePermissionRequest) returns (Empty) {}
	rpc RevokePermission(UpdatePermissionRequest) returns (Empty) {}

	rpc List(IdRequest) returns (ListAccAgentResponse) {}
	rpc Lock(AccIdRequest) returns (Empty) {}
	rpc Unlock(AccIdRequest) returns (Empty) {}
}

message LoginRequest {
	string email = 1;
	string password = 2;
}

message ListAccAgentResponse {
	repeated AccountAgent AccAgents = 1;
}

message ResetPWRequest {
	string AgentId = 1;
	string NewPassword = 2;
}

message RegisterClientRequest {
	string AgentId = 1;
	string ClientId = 2;

	// true if client update their scope and agent haven't notice yet
	bool InvalidScope = 3;
	string RegisterDate = 4;
	repeated int32 ScopeIds = 5;
}

service AgentMgr {
	rpc Search(SearchAgentRequest) returns (SearchAgentResponse) {}
	rpc Register(Agent) returns (IdResponse) {}
	rpc Read(IdRequest) returns (Agent) {}

	rpc List(IdRequest) returns (ListAgentsResponse) {}
	rpc Lock(IdRequest) returns (Empty) {}
	rpc Unlock(IdRequest) returns (Empty) {}
	rpc ResetPW(ResetPWRequest) returns (Empty) {}
	rpc Confirm(IdRequest) returns (Empty) {}
	rpc Login(LoginRequest) returns (IdResponse) {}

	rpc UpdateProfile(Agent) returns (Empty) {}

	rpc AuthorizeClient(RegisterClientRequest) returns (Empty) {}
	rpc RevokeClient(RegisterClientRequest) returns (Empty) {}
	rpc ListClient(IdRequest) returns (ListClientsResponse) {}
}

message SearchAgentResponse {
	repeated Agent Agents = 1;
}

message ListAccountChannelResponse {
	repeated string Ids = 1;
}

message AccountTypeResponse {
	int32 Type = 1;
}

message LimitsResponse {
	repeated Limit Limits = 1;
}

message Limit {
	int32 ConcurrentChat = 1;
	int32 ChatHistory = 2;
	int32 MaxTriggers = 3;
	int32 MaxAgents = 4;
}

message CreateResponse {
	string id = 3;
}

message AgentCreateResponse {
	ErrorCode error = 1;
	string error_description = 2;
	string id = 3;
}

message Agent {
	string Id = 1;
	string FirstName = 2;
	string LastName = 3;
	string Email = 4;
	bool IsVerified = 8;
	string LastLoginTime = 9;
	string AvatarUrl = 11;
	string Language = 12;
	string Timezone = 13;
	Status Status = 14;
}

message Configuration {
	bool Sound = 1;
	bool NewChatNoti = 2;
	NotificationConfig EmailNoti = 3;
	NotificationConfig SubizNoti = 4;
}

message NotificationConfig {
	bool NewDirectMessage = 1;
	bool SubizMaintainMessage = 2;
}
enum AvailableState {
	Available = 0;
	Away = 1;
};

enum Status {
	Normal = 0;
	Locked = 1;
}

message AccountAgent {
	string AgentId = 1;
	string IsOwner = 2;
	string AccountId = 3;
	string FirstName = 4;
	string LastName = 5;
	string AvatarUrl = 6;
	string Language = 7;
	string Timezone = 8;
	string JobTitle = 9;
	auth.Scope Scopes = 10;
	Status status = 18;
	string HashedPassword = 11;
	AvailableState AvailableState = 12;
	int32 Rate = 13;

	string JoinDate = 14;
	string InviteFromAgentId = 15;
	// set if account agent is removed from account

	// set to true if agent is being invited
	bool IsInviting = 17;
}

message IdResponse {
	string Id = 1;
}

message ListAgentsRequest {
	string AccountId = 1;
}

message ListClientsResponse {
	repeated int32 clients = 1;
}

message ListAgentsResponse {
	repeated Agent agents = 1;
}

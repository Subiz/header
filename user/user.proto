syntax = "proto2";

package user;

import "bitbucket.org/subiz/header/common/common.proto";

message AllType {
	optional User user = 2;
	optional CreateRequest cr = 3;
	optional Field fields = 5;
	optional UserCreateResult ucr = 6;
	optional ReadTopicRequest rpr = 8;
	optional UserSearchRequest usersearchrequest = 9;
	optional UserSearchResult usersearchresult = 10;
	optional MaskResponse ms = 11;
	optional ListTopicsResult ltr = 12;
	optional Segmentation sg = 14;
	optional Presence presn = 15;
	optional Visitor vi = 17;
	optional Visitors vis = 18;
	optional Topic topic = 19;
	optional UnreadTopic utopic = 20;
	optional MyUser myuser = 21;
	optional Automation automation = 23;
	optional Automations automations = 25;
	optional Session session = 26;
}

service MyServer {
	rpc Do(AllType) returns(AllType) {}
}

message AddToMyRequest {
	optional common.Context ctx = 1;
	optional string user_id = 3;
	repeated string agent_ids = 5;
}

message UserCreateResult {
	optional string id = 3;
	optional string mask = 5;
}

message MyUser {
	optional common.Context ctx = 1;
	optional string agent_id = 2;
	optional User user = 3;
	optional int32 unread = 4;
	optional int64 updated = 5;
}

enum AttributeType {
	text = 0;
	number = 1;
	boolean = 2;
	datetime = 3;
	list = 4;
}

enum AttributeKind {
	system = 0;
	default = 1;
	custom = 2;
}

message AttributeDefinition {
	optional common.Context ctx = 1;
	optional string account_id = 2;
	optional string name = 3;
	optional string description = 4;
	optional string type = 5;
	repeated string list_items = 6;
	optional string key = 7;
	optional string kind = 8;
	optional int64 updated = 9;
}

message AttributeDefinitions {
	optional common.Context ctx = 1;
	repeated AttributeDefinition attributes = 2;
}

enum AttributeDataState {
	live = 0;
	deleted = 1;
}

message AttributeData {
	optional common.Context ctx = 1;
	optional string account_id = 2;
	optional string user_id = 3;
	optional string key = 4;
	optional string value = 5;
	optional string state = 6;
	optional int64 created = 7;
	optional int64 modified = 8;

	optional string text = 10;
	optional double number = 11;
	optional bool boolean = 12;
	optional string date = 13;
	repeated string list = 14;
}

message User {
	optional common.Context ctx = 1;
	optional string id = 3;
	optional string account_id = 4;
	optional string fullname = 5;
	repeated string phones = 7;
	repeated string emails = 10;
	repeated Trace traces = 11;
	//	repeated string alias = 12;
	repeated Device devices = 13;
	optional bool is_ban = 14;
	optional string avatar_url = 15;

	repeated AttributeData attributes = 18;

	repeated string segments = 19;
	repeated string labels = 20;
	optional bool unsubscribed = 21;
	optional bool marked_spam = 22;
	optional bool hard_bounced = 23;
	optional int32 total_sessions = 24;

	optional string subiz_id = 25;
	optional string timezone = 26;
	optional string country_code = 27;
	optional string city = 32;
	optional string language = 28;

	repeated string aliases = 30;
	optional int64 seen = 31;
	repeated Field fields = 33;

	optional int32 par = 34;
	// optional int32 modified_hour = 35;
	optional int64 modified = 36;
	optional int32 modified_week = 37;
	optional int64 activated = 38;
}

message Users {
	repeated User users = 1;
}

message Device {
	optional int32 id = 3;
	optional int32 useragent_id = 4;
	optional string useragent = 5;
	optional string screen_resolution = 6;
	optional int32 language_id = 7;
	optional string language = 8;
}

message Trace {
	optional string id = 3;
	optional string ip = 4;
	optional int32 location_id = 5;

	optional string city_name = 8;
	optional string country_name = 9;
	optional string country_code = 19;
	optional string continent_code = 10;
	optional string continent_name = 18;

	//optional string coutry_code = 11;
	optional float latitude = 12;
	optional float longitude = 13;
	optional string postal_code = 14;
	optional string timezone = 16;

	optional string isp = 17;
}

message MergeRequest {
	optional common.Context ctx = 1;
	optional string id = 5;
	optional string recent_id = 4;
}

message CreateRequest {
	optional string challenge_id = 3;
	optional string answer = 4;
}

message Topic {
	optional common.Context ctx = 1;
	optional string account_id = 2;
	optional string topic = 3;
	optional string type = 5;
	optional int64 updated = 8;
	optional int32 unread = 9;
}

message UnreadTopic {
	optional common.Context ctx = 1;
	optional string topic = 3;
	optional string agent_id = 4;
	optional string user_id = 5;
	optional string type = 6;
	optional int64 updated = 8;
	optional int32 unread = 9;
}

message ReadTopicRequest {
	optional common.Context ctx = 1;
	optional string topic = 3;
	optional string user_id = 4;
	optional string agent_id = 5;
}

message SubscribeRequest {
	optional common.Context ctx = 1;
	optional string agent_id = 3;
	repeated string topics = 4;
}

enum Event {
	UserReadRequested = 0; // Id

	UserUpdateRequested = 2; // User
	UserCreateRequested = 3; // User
	UserSearchRequested = 4; // Ids

	UserEventCreateRequested = 5; // rawevent -> raw event
	UserEventSearchRequested = 7; // listeventsrequest -> rawevents
	UserTopicSearchRequested = 6; // listtopicsrequest -> listtopicsresult

	UserSegmentationCreateRequested = 10;
	UserSegmentationUpdateRequested = 11;
	UserSegmentationDeleteRequested = 12;
	UserSegmentationListRequested = 13;
	UserSegmentationReadRequested = 14;

	UserAddToMyListRequested = 20;


	UserEventTopicSubscribeRequested = 35;
	UserEventTopicUnsubscribeRequested = 36;

	UserReadTopicRequested = 41; // ReadTopicRequest -> Empty

	UserSubizId = 42;

	UserPresenceReadRequested = 44;
	UserPreviewingReadRequested = 46;
	UserListTopRequested = 47;

	UserAutomationUpsertRequested = 50;
	UserAutomationDeleteRequested = 51;
	UserAutomationListRequested = 52;
	UserAutomationReadRequested = 53;


	AutomationAgentNotificationFired = 54;
	AutomationConversationMessageFired = 55;

	UserSessionUpdateRequested = 65;
	UserSessionCreateRequested = 66;
	UserSessionReadRequested = 67;

	SegmentationLoop = 68;

	AutomationSynced = 102;
	AutomationFired = 103;
	UserRequested = 100;

	UserCreated = 70;
	UserAttributeAdded = 71;

	UserSynced = 101;
	UserUpserted = 105;
	UserV3Synced = 106;
}

message SubizIDRequest {
	optional common.Context ctx = 1;
	optional string subiz_id = 2;
	optional string account_id = 3;
}

message MaskResponse {
	optional string subiz_id = 2;
	optional string account_id = 3;
	optional string user_id = 4;
	optional string mask = 5;
}

message SubizIDResponse {
	optional common.Context ctx = 1;
	optional string subiz_id = 2;
	optional string account_id = 3;
	optional string user_id = 4;
}

message Segmentations {
	optional common.Context ctx = 1;
	repeated Segmentation segmentations = 3;
}

message SegmentLoopState {
	optional common.Context ctx = 1;
	optional string account_id = 2;
	optional int32 user_par = 3;
	optional int64 loop_created = 6;
	optional int64 loop_number = 7;
}

message UserSegmentCache {
		optional common.Context ctx = 1;
	optional string account_id = 2;
	optional string id = 3;
	optional string condition_id = 4;

}

message Segmentation {
	optional common.Context ctx = 1;
	optional string account_id = 2;
	optional string id = 5;
	optional string name = 3;
	optional string description = 11;
	optional int64 user_count = 4;
	// repeated Condition conditions = 6;
	//repeated SegmentCondition query = 5; // suffix annotation
	// a * b + (c + d) * e  ==>  + * a b * + c d e
	optional int64 ran = 8; // time start run
	optional int64 started_from = 7;

	optional int64 created = 9;
	optional int64 modified = 10;
	optional string state = 12;
	enum State {
		active = 0;
		inactive = 1;
	}

	optional SegmentCondition condition = 19;
	optional string current_cursor = 18;
}

message SegmentTracking {
	optional common.Context ctx = 1;
	optional int32 user_par = 2;
	optional string account_id = 3;

	optional int64 loop_created = 7;
	optional int64 loop_number = 8;
}

message SegmentCondition {
	enum JoinOperator {
		none = 0;
		and = 1;
		or = 2;
	}

	optional string join = 2;

	optional string id = 4;
	optional string event_type = 5;

	enum Composition {
		true = 0;
		sum = 1; // rurn number
		avg = 2; // return number
		count = 3; // return number
	}
	optional string composition = 6;
	optional string key = 7;

	repeated Condition conditions = 8;

	optional SegmentCondition left_condition = 11;
	optional SegmentCondition right_condition = 12;
}

message Condition {
	enum JoinOperator {
		none = 0;
		and = 1;
		or = 2;
	}
	optional string join = 1;
	optional string key = 2; // unique
	optional string operator = 3; // = # regex
	optional string value = 4; // JSON
}

message UserSearchResult {
	optional common.Context ctx = 1;
	optional int64 total = 3;
	repeated User users = 4;
	optional string anchor = 5;
	repeated int32 unreads = 6; // only used when search my users
	map<string, int32> unread_counts = 7;
}

message UserSearchRequest {
	optional common.Context ctx = 1;
	optional string segmentation_id = 3;
	optional string query = 4;
	optional string anchor = 5;
	optional int32 limit = 6;
	optional string agent_id = 8; // search my user of agent
	optional bool unread = 9; // search my user of agent
}

message IndexEvent {
	optional string id = 3;
	optional string account_id = 4;
	optional string user_id = 5;
	optional int64 created = 6;
	optional string category = 7; // eventtype
	repeated string topics = 8;
	optional string object = 9;
	optional string text = 10;
}

message ListTopicsRequest {
	optional common.Context ctx = 1;
	optional string user_id = 3;
	optional string agent_id = 5;
	optional string anchor = 4;
	optional int32 limit = 7;
	optional bool unread = 8;
}

message ListTopicsResult {
	optional common.Context ctx = 1;
	repeated Topic topics = 3;
	optional string anchor = 5;
}

message ListNewsRequest {
	optional common.Context ctx = 1;
	optional string user_id = 3;
	optional int64 start_time = 4;
 	optional string limit = 7;
}

message AddToMyList {
	optional common.Context ctx = 1;
	optional string agent_id = 2;
	optional string user_id = 3;
}

message Field {
	optional string name = 2;
	optional string account_id = 3;
	optional string user_id = 4;
	optional string setter = 5;
	optional string setter_type = 6;
	optional int64 updated = 8;
	optional string data = 9;
	optional string id = 10;
}

message Presence {
	optional common.Context ctx = 1;
	optional string account_id = 3;
	optional string user_id = 4;
	optional int64 pinged = 5;
	optional int64 pinged_minute = 6;
}

message Presences {
	optional common.Context ctx = 1;
	repeated Presence presences = 2;
}

message Visitor {
	optional common.Context ctx = 1;
	optional string account_id = 3;
	optional User user = 4;
	optional int64 pinged = 5;
	optional string page_url = 6;
	optional int64 page_viewed = 7;
	optional string page_title = 8;
}

message Visitors {
	optional common.Context ctx = 1;
	repeated Visitor visitors = 2;
}

message LastView {
	optional string account_id = 3;
	optional string user_id = 4;
	optional string url = 5;
	optional string ua = 6;
	optional string ip = 7;
	optional int64 created = 8;
	optional string event_id = 9;
	optional string title = 10;
}

message Automation {
	optional common.Context ctx = 1;
	optional string account_id = 2;
	optional string id = 3;
	optional string channel = 4;
	optional string name = 5;
	optional string description = 6;
	repeated Condition conditions = 7;

	//repeated SegmentCondition query = 5; // suffix annotation
	// a * b + (c + d) * e  ==>  + * a b * + c d e

	optional int64 created = 9;
	optional int64 modified = 10;
	optional string state = 12;
	enum State {
		active = 0;
		inactive = 1;
	}

	optional string action_type = 13;
	enum ActionType {
		conversation_message = 0;
		agent_notification = 1;
		//user_notification = 2;
		automation_invite_message = 4;
	}
	optional string action_data = 14;
	optional string scope = 15;
}

enum AutomationScope {
	conversation = 2;
	user = 3;
}

message Automations {
	optional common.Context ctx = 1;
	repeated Automation automations = 2;
}

message Session {
	optional common.Context ctx = 1;
	optional string account_id = 3;
	optional string user_id = 4;
	optional string id = 5;
	optional string platform = 7;
	enum Platform {
		web = 0;
		mobile = 2;
		desktop = 4;
	}
	optional string referrer = 8;
	optional string search_engine = 9;

	optional int64 started = 10;
	optional int64 tracked = 11;
	optional string status = 12;
	enum Status {
		open = 0;
		closed = 1;
	}
	optional int32 events_count = 13;
	optional int32 content_views_count = 14;
	optional string search_term = 15;
}

message DeleteAttrRequest {
	optional common.Context ctx = 1;
	optional string key = 2;
}

service SegmentationMgr {
	rpc CreateSegment (Segmentation) returns (Segmentation) {}
	rpc UpdateSegment (Segmentation) returns (Segmentation) {}
	rpc ListSegments (common.Id) returns (Segmentations) {}
	rpc DeleteSegment (common.Id) returns (common.Empty) {}
	rpc ReadSegment (common.Id) returns (Segmentation) {}
}

service VisitorMgr {
	rpc ReadPresence (common.Id) returns (Presence) {}
	rpc ReadPresences (common.Ids) returns (Presences) {}
	rpc ReadPreview (common.Id) returns (LastView) {}
	rpc ListTopVisitors (common.Id) returns (Visitors) {}
}

message CountMyUserRequest {
	optional string agent_id = 4;
	optional int32 from = 5;
	optional int32 to = 6;
	optional string range = 8;
	enum Range {
		hour = 0;
		day = 1;
	}
}

message CountUserRequest {
	optional int32 from = 5;
	optional int32 to = 6;
	optional string range = 8;
	enum Range {
		hour = 0;
		day = 1;
	}
}

message CountUserByAttributeRequest {
	optional string attribute_key = 4;
	optional int32 from = 5;
	optional int32 to = 6;
	optional string range = 8;
	enum Range {
		hour = 0;
		day = 1;
	}
}

message CountResponse {
	repeated int32 data = 3;
}

service UserMgr {
	rpc SearchUsers (UserSearchRequest) returns (UserSearchResult) {}
	rpc SubizID (SubizIDRequest) returns (SubizIDResponse) {}
	rpc AddToMy (AddToMyRequest) returns (common.Empty) {}
	rpc CreateUser (User) returns (User) {}
	rpc UpdateUser (User) returns (User) {}
	rpc ReadUser (common.Id) returns (User) {}
	rpc RemoveFromMy (common.Id) returns (common.Empty) {}

	rpc CountMyUser(CountMyUserRequest) returns (CountResponse) {}
	rpc CountUser(CountUserRequest) returns (CountResponse) {}
	rpc CountUserByAttribute(CountUserByAttributeRequest) returns (CountResponse) {}
}

service AutomationMgr {
	rpc ListAutomations(common.Id) returns (Automations) {}
	rpc UpdateAutomation(Automation) returns (Automation) {}
	rpc DeleteAutomation(common.Id) returns (common.Empty) {}
	rpc ReadAutomation(common.Id) returns (Automation) {}
	rpc CreateAutomation(Automation) returns (Automation) {}
}

service SessionMgr {
	rpc CreateSession(Session) returns (Session) {}
	rpc ReadSession(Session) returns (Session) {}
	rpc UpdateSession(Session) returns (Session) {}
}

service AttributeMgr {
	rpc ListAttributeDefinitions(common.Empty) returns (AttributeDefinitions) {}
	rpc CreateAttributeDefinition(AttributeDefinition) returns (AttributeDefinition) {}
	rpc UpdateAttributeDefinition(AttributeDefinition) returns (AttributeDefinition) {}
	rpc DeleteAttributeDefinition(DeleteAttrRequest) returns (common.Empty) {}
}

message AutomationCheck {
	optional string account_id = 2;
	optional string automation_id = 3;
	optional string user_id = 4;
	optional string event_id = 5;
	optional string scope = 6;
}

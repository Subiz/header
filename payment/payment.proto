syntax = "proto2";

package payment;

import "git.subiz.net/header/common/common.proto";
import "git.subiz.net/header/lang/lang.proto";

enum Currency {
	usd = 0;
	vnd = 1;
	brl = 2;
}

message ListCommentsRequest {
	optional common.Context ctx = 1;
	optional string account_id = 2;
	optional string object_type = 3;
}

message Comments {
	optional common.Context ctx = 1;
	optional string account_id = 2;
	repeated Comment comments = 3;
}

message Comment {
	optional common.Context ctx = 1;
	optional string account_id = 2;
	optional string id = 3;
	optional string topic_id = 4;
	optional string topic_type = 5;
	optional string author_account_id = 8;
	optional string author_id = 9;
	optional string author_email = 10;
	optional string content = 11;
	optional int64 created = 12;
}

message Stripe {
	optional string card_last4 = 2;
	optional string customer_id = 3;
	optional string token = 4; // REST only
}

message PaymentMethods {
	repeated PaymentMethod payment_methods = 2;
}

message PaymentMethod {
	optional common.Context ctx = 1;
	enum Type {
		bank_transfer = 0;
		credit_card = 1;
	}

	optional string type = 2;
	optional string id = 3;
	optional string account_id = 4;
	enum State {
		active = 0;
		failed = 1;
	}
	optional string state = 5;
	optional int64 created = 8;
	optional Stripe stripe = 9;
	optional string failed_message = 10;
	optional int64 charged = 11;
}

message Limit {
	optional common.Context ctx = 1;
	optional string account_id = 3;
	optional uint32 max_automations = 4;
	// optional uint32 max_conversations = 6;
	optional uint32 max_segments = 7;
	optional uint32 max_agents = 8;
	optional bool can_buy_agent = 10;

	optional uint32 automation_webhook_quota = 12;
	optional uint32 automation_email_quota = 13;
	optional uint32 automation_message_quota = 14;

	optional uint32 max_rules = 16;
}

message Plans {
	repeated Plan plans = 2;
}

message Plan {
	optional string name = 2;
	optional Limit limit = 3;
	optional float price = 4; // usd
	enum Type {
		trial = 0;
		free = 1;
		standard = 2;
		advanced = 3;
	}
	optional uint32 level = 14;
	optional bool can_buy_agent = 15;
	optional bool can_buy = 16;
	optional bool has_start_time = 17;
}

message Subscription {
	optional common.Context ctx = 1;
	optional string account_id = 3;
	optional int64 created = 11;
	optional string promotion_code = 4;
	optional string name = 7;
	optional int64 started = 5;
	optional int64 due_date = 6; // read-only
	optional bool auto_renew = 9;

	optional uint32 billing_cycle_month = 15;
	optional uint32 next_billing_cycle_month = 16;
	optional string plan = 17;

	repeated Addon addons = 21;

	optional float credit = 27;
	repeated Note notes = 28;
	optional string referral_by = 29; // account_id
	optional Customer customer = 31;
	optional string primary_payment_method = 32;
	optional Limit limit = 42;
	optional int32 v3_state = 43;
}

message Bill {
	optional common.Context ctx = 1;
	optional string id = 3;
	optional string account_id = 4;
	optional float amount = 5;
	repeated string invoice_ids = 6;
	optional int64 created = 7;
	optional Contact customer_info = 8;
	optional string payment_method = 10;
	optional int32 year = 11;
	optional string description = 12;
}

message Note {
	optional common.Context ctx = 1;
	optional string message = 4;
	optional string creator = 5;
	optional int64 created = 6;
}

message Invoices {
	repeated Invoice invoices = 2;
	optional string account_id = 3;
	optional string anchor = 4;
}

message ListInvoiceByStateRequest {
	optional common.Context ctx = 1;
	optional string state = 2;
	optional int32 limit = 3;
	optional string anchor = 4;
}

message Invoice {
	optional common.Context ctx = 1;
	optional string account_id = 2;
	optional string id = 3;
	optional float amount_due = 4;
	optional string promotion_code = 5;
	optional string description = 6;
	optional BillingInfo billing_info = 8;
	optional int64 due_date = 9;

	enum State {
		draft = 0;
		open = 1;
		overdue = 2;
		paid = 3;
		voided = 4;
		queueing = 5;
	}
	optional string state = 10;
	optional int64 created = 11;
	repeated InvoiceItem items = 12;
	optional float subtotal = 14;
	optional float tax_percent = 15;
	optional float tax = 16;
	optional float total = 17;
	optional int64 updated = 18;
	optional int32 year = 19; // optional
	repeated Note notes = 22;
	repeated string bills = 23;
	optional float payment_made = 24;
	optional Subscription current_sub = 25; // optional
	optional Plan current_plan = 26; // optional
}

message AgentInvoiceItem {
	optional string plan = 3;
	optional int32 day_left = 4;
	optional int32 agent_count = 8;
}

message RenewInvoiceItem {
	optional string plan = 3;
	optional uint32 billing_cycle_month = 4;
	optional uint32 agent_count = 5;
	optional int64 from_time = 6;
}

message PlanInvoiceItem {
	optional uint32 agent_count = 2;
	optional uint32 billing_cycle_month = 5;
	optional string old_plan = 6;
	optional string new_plan = 3;
	optional float save_percentage = 9;
	optional int64 started = 8;
	optional int32 day_left = 4;
}

message InvoiceItem {
	optional string description = 5; // remove
	optional string invoice_id = 6; // remove
	optional int32 quantity = 7;
	optional float price = 8; // per unit
	message Data {
		optional RenewInvoiceItem renew = 2;
		optional AgentInvoiceItem agent = 3;
		optional PlanInvoiceItem plan = 5;
	}
	optional Data data = 9;
}

message BillingInfo {
	optional string name = 2;
	optional string address = 3;
	optional string vat = 4;
	optional string country_code = 5;
}

message Contact {
	optional common.Context ctx = 1;
	optional string name = 2;
	optional string email = 3;
	optional string phone = 4;
	optional string job_title = 5;

	enum Title {
		mr = 0;
		ms = 1;
		mrs = 2;
		dr = 3;
	}
	optional string title = 6;
	optional bool primary = 7;
}

message Customer {
	optional string id = 2;
	optional string account_id = 3;

	repeated Contact contacts = 4;
	optional int64 created = 5;
	optional BillingInfo billing_info = 6;
}

message FixedAmountPromotionCode {
	optional float amount = 2;
}

message PercentPromotionCode {
	optional float percent = 2;
}

message CreditCode {
	optional float credit = 2;
}

message ReferralCreditCode {
	optional string referrer_id = 2;
	optional float credit = 3;
}

message PromotionCode {
	optional common.Context ctx = 1;
	optional string description = 3;

	enum Type {
		fixed_amount_promotion_code = 0;
		percent_promotion_code = 1;
		credit_code = 2;
		referral_credit_code = 3;
	}
	optional string type = 6;

	optional int32 redeem_count = 5;
	optional string creator = 9;
	optional int64 created = 10;
	optional string code = 11;

	message Data {
		optional FixedAmountPromotionCode fixed_amount = 1;
		optional PercentPromotionCode percent = 2;
		optional CreditCode credit = 3;
		optional ReferralCreditCode referral = 4;
	}
	optional Data data = 14;

	optional int64 start = 16;
	optional int64 end = 17;
	optional string for_plan = 18;
	optional string for_account_id = 19;
	optional int32 max_redemptions = 20;
	optional string addon = 21;
	repeated string for_items = 23;

	optional float min_amount = 24;
	optional float max_amount = 25;
}

message ExchangeRate {
	optional string from_currency = 2;
	optional string to_currency = 3;
	optional float exchange_rate = 4;
	optional int64 exchange_time = 5; // nanosec
}

message Log {
	optional common.Context ctx = 1;
	enum Action {
		create_invoice = 0;
		change_invoice_status = 1;
		create_discount = 2;
		delete_discount = 3;
		redeem_discount = 4;
		add_credit = 5;
		redeem_credit = 6;
		delete_account = 7;
		change_plan = 8;
		renew_subscription = 10;
		click_subscribe_button = 11;
		pay_for_referrer = 12;
		add_money_for_referrer = 13;
		pay_invoice = 14;
	}
	optional string user = 2;
	optional string id = 8;
	optional string action = 3;
	optional int64 created = 4;
	optional string description = 5;
	optional string account_id = 6;
	optional int32 month = 7;
}

message Addon {
	enum Type {
		credit = 0;
		agent = 1;
	}
	optional string type = 2;
	optional string name = 3;
	optional float price = 4;
	optional Currency currency = 5;

	enum ChargeType {
		one_time = 0;
		recurring = 1;
	}
	optional string charge_type = 6;
	optional int32 period = 7;

	enum PeriodUnit {
		day = 0;
		week = 1;
		month = 2;
		year = 3;
	}
	optional string period_unit = 8;
	optional int32 quantity = 9;
	optional int64 created = 10;
}

enum Event {
	PaymentSynced = 0;
	LimitUpdated = 1;
	PaymentRequested = 4;
	PaymentRenewCycle = 5;
	InvoiceCreatedEmailSend = 6;
	PaymentV3Synced = 8;

	SubscriptionUpdated = 14;
	InvoiceUpdated = 10;
	PaymentMethodUpdated = 11;
	BillingUpdated = 12;
	LogUpdated = 13;
	PromotionCodeUpdated = 15;

	PaymentJob = 16;
	PaymentJobAddPaymentMethod = 17;
	PaymentJobDeletePaymentMethod = 18;
	PaymentJobPayInvoice = 19;
	PaymentJobPay = 20;
	PaymentJobPurchase = 21;
	PaymentJobUpdateSubscription = 22;
	PaymentJobRenew = 23;
	PaymentJobUpdatePaymentMethod = 24;
	PaymentJobTransferMoney = 25;
	PaymentJobUpsertAgent = 26;
	PaymentJobCreateInvoice = 27;

	PaymentDowngradeCron = 28;
	PaymentGenerateInvoiceCron = 29;
	PaymentPayCron = 30;

	PaymentWorkerJob = 40;
}

message PaymentRenewCycleRequested {
	optional common.Context ctx = 1;
	optional string account_id = 2;
	optional Subscription sub = 3;
	optional string cycle_id = 4;
}

service SubizInternalPaymentMgr {
	rpc CreateBill(Bill) returns (Bill);
	rpc UpdateExchangeRate(ExchangeRate) returns (ExchangeRate);
	rpc Ping(common.PingRequest) returns (common.Pong);
}

service PaymentMgr {
	rpc Purchase(Subscription) returns (Invoice);
	rpc UpdateSubscription(Subscription) returns (Subscription);
	rpc GetSubscription(common.Empty) returns (Subscription);
	rpc GetPromotionCode(String) returns (PromotionCode);
	rpc AddPaymentMethod(PaymentMethod) returns (PaymentMethod);
	rpc UpdatePaymentMethod(PaymentMethod) returns (PaymentMethod);
	rpc DeletePaymentMethod(common.Id) returns (common.Empty);
	rpc ListPaymentMethods(common.Empty) returns (PaymentMethods);
	rpc Pay(PayRequest) returns (Bill);
	rpc ListInvoices(common.Id) returns (Invoices);
	rpc CreateInvoice(Invoice) returns (Invoice);
	rpc UpdateInvoice(Invoice) returns (Invoice);
	rpc ListInvoicesByState(ListInvoiceByStateRequest) returns (Invoices);

	rpc ListComments(ListCommentsRequest) returns (Comments);
	rpc AddComment(Comment) returns (Comment);
	rpc ListPlans(common.Empty) returns (Plans);
	rpc ExportInvoice(common.Id) returns (String);
	rpc GetExchangeRate(ExchangeRate) returns (ExchangeRate);
	rpc TransferMoney(PayRequest) returns (Bill);
	rpc Ping(common.PingRequest) returns (common.Pong);
}

message String {
	optional string str = 2;
}

message PayRequest {
	optional common.Context ctx = 1;
	optional string account_id = 8;
	repeated string invoice_ids = 6;
	optional string description = 7;
	optional Contact CustomerInfo = 9;
	optional float amount = 10;
}

message ESubscription { // subscription with error
	optional Subscription sub = 2;
	optional string err = 3;
}

message EInvoice { // invoice with error
	optional Invoice inv = 3;
	optional string err = 4;
}

message InvoiceCreatedEmail {
	optional common.Context ctx = 1;
	optional string to = 2;
	optional string account_id = 3;
	optional string billing_name = 4;
	optional string invoice_id = 5;
	optional int64 created = 6;
	optional lang.L lang = 8;
	optional string from = 10;
}
